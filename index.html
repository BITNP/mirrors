<!DOCTYPE html>
<html lang="en">
  
  <head>
    <meta charset="UTF-8">
    <meta name="author" content="Maidong">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,shrink-to-fit=no">
    <!-- 兼容IOS9 -->
    <title>北理镜像站</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="{% css bootstrap.min %}">
  </head>
    <style>
      .mir-shadow{ box-shadow: 10px 10px 15px #8e8e8e; } 
      #gotoTop{ position: fixed; bottom: 10px; right: 10px; width: 50px; height: 50px; opacity: 0.5; } 
      #gotoTop:hover{ opacity: 1; }
      .erweima { 
        position:fixed; 
        overflow: hidden;
        top:50%; 
        left:50%; 
        margin:-100px 0 0 -180px;  
        width:360px; 
        height:200px;
        background-color: white;
        box-shadow: 0 0 50px #ccc; 
        border-radius: 10px 10px 10px 10px; 
        line-height:200px; 
        font-size:16px; 
        text-align:center; 
        z-index:99;
        display: none; 
      } 
    </style>
  <body>
    {% template body_header %}
    <main>
      <section class="jumbotron text-center mb-0">
        <div class="container">
          <h1 class="jumbotron-heading">北京理工大学开源软件镜像站</h1>
          <p>网络开拓者协会（Net Pioneer Association of BIT，以下简称网协），成立于1997年，是北京理工大学校内规模最大的社团之一，本着“网络无限，开拓不懈”的精神，不断摸索、引领校园网络建设，后成为校团委领导的全校唯一IT类学生组织。经过20年的不断成长，各项规章制度和硬件设备基本完善，成长为北理最大的网络服务提供团体，拥有每日最高的访问量，从学校学生工作，到日常娱乐服务，协会的服务范围仍然在继续的扩大。同时，协会自身也在不断努力的增强实力，拓展业务。</p>
          <p>
            <a href="./mirror" class="btn btn-primary">进入下载页</a>
            <a href="./help" class="btn btn-secondary">帮助</a></p>
        </div>
      </section>
      <div class="py-5 bg-light">
        <div class="container" id="main_container">
          <div class="row">

          </div>
        </div>
      </div>
    </main>

    {% template body_footer %}
    
    <a id="gotoTop" href="#">
      <img src="./Assets/img/gotoTop.png" width="50" height="50" alt="" />
    </a>
    <div class="erweima">
      <img src="./Assets/img/erweima.jpg" alt="">
    </div>

    <script src="{% js jquery.min %}"></script>
    <script src="{% js popper.min %}"></script>
    <script src="{% js bootstrap.min %}"></script>
    <script src="{% js socket.io-2.0.3 %}"></script>
    <script src="{% js functions %}"></script>
    <script>
      "use strict"

      var requests = GetRequest();

      var socket = io('{% IPAddress %}');

      socket.emit('data', {
        "type": "mirrorDir"
      });
      socket.on('data',
      function(data) {
        data = dataFilter(data);
        window.data = data; // 将数据放到全局环境中保存起来，以便瀑布流模式加载
        loadHTML(data.datas);
      });

      // 加载数据, 默认加载9项
      // model
      // 		0：全加载
      // 		1：瀑布流模式，num设置加载数，默认为9项, 从start处开始加载
      function loadHTML(data, model = 1, num = 9, start = 0) {
        // var html = '';
        var main_container = document.getElementById('main_container');
        if (model == 1) {
          var row = main_container.getElementsByClassName('row')[0];
          if (!row) {
            var div_row = document.createElement('div');
            div_row.className = "row";
            document.getElementById('main_container').appendChild(div_row);
            row = main_container.getElementsByClassName('row')[0];
          }
          for (var mir = start; mir < start + num && mir < data.length; mir++) {
            var Name = data[mir].path;
            var Img = Name + '.png';
      			var div = document.createElement('div');
      			div.className = "col-md-4";
      			div.id = 'item_' + mir;
      			var div1 = document.createElement('div');
      			div1.className = "card mb-4 mt-4 box-shadow mir-shadow";
      			div.appendChild(div1);
      			var image = document.createElement('img');
      			image.className = "card-img-top";
      			image.src = "./Assets/img/" + Img;
      			image.alt = "Card image cap";
      			div1.appendChild(image);
      			var div2 = document.createElement('div');
      			div2.className = 'card-body';
      			div1.appendChild(div2);
      			var p = document.createElement('p');
      			p.className = "card-text";
      			p.innerText = Name;
      			div2.appendChild(p);
      			var div3 = document.createElement('div');
      			div3.className = "d-flex justify-content-between align-items-center";
      			div2.appendChild(div3);
      			var div4 = document.createElement('div');
      			div4.className = "btn-group";
      			div3.appendChild(div4);
            var btn = '\
            <button class="btn btn-sm btn-outline-secondary" type="button" name="' + Name + '">下载</button>\
            <button class="btn btn-sm btn-outline-secondary" type="button" name="' + Name + '">帮助</button>\
            <button class="btn btn-sm btn-outline-secondary" type="button" name="' + Name + '">反馈</button>';
            div4.innerHTML = btn;
      			row.appendChild(div);
          }
        }
        addCilckActions();
      }
      // 绑定鼠标单击事件
      function addCilckActions() {
        $(".btn-outline-secondary[name]").click(function() {
          console.log($(this).index());
          var name = $(this).attr("name");
          switch($(this).index()) {
            case 0: /*下载*/
            {
              var href = window.location.pathname;
              var hrefArr = href.split('/');
              href = href.substring(0, href.length - hrefArr[hrefArr.length - 1].length);
              href += 'mirror/' + name;
              window.location.href = href;
            }
            break;
            case 1: /*帮助*/
            {
              var href = window.location.pathname;
              var hrefArr = href.split('/');
              href = href.substring(0, href.length - hrefArr[hrefArr.length - 1].length);
              href += 'help/' + name;
              window.location.href = href;
            }
            break;
            case 2: /*反馈*/
            {
              $(".erweima").show();
            }
            break;
          }
        });
        $(".erweima").click(function(){
          $(this).hide();
        });
      }

      // 瀑布流模式加载数据
      window.onscroll = function() {
        if (checkLoad()) {
          var nodeNum = $("#main_container .row").children().length;
          loadHTML(data.datas, 1, 9, nodeNum);
        }
      }

      // 瀑布流模式, 检查是否应该加载
      function checkLoad() {
        var contentHeight = $(".col-md-4:last").offset().top;
        var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        var pageHeight = document.documentElement.clientHeight || document.body.clientHeight;
        if (contentHeight < scrollTop + pageHeight) {
          return true;
        }
      };</script>
  </body>
</html>