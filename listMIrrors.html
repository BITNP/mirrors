<!DOCTYPE html>
<html lang="en">
  
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,shrink-to-fit=no">
    <!-- listMirrors -->
    <!-- 兼容IOS9 -->
    <title>北理镜像站</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"></head>
  
  <body>
    <header>
      <div class="collapse bg-dark" id="headerNav">
        <div class="container">
          <div class="row">
            <div class="col-sm-8 col-md-7 py-4">
              <h4 class="text-white">About</h4>
              <p class="text-muted">北理镜像站是由北京理工大学网络开拓者协会负责运营的开源镜像站</p></div>
            <div class="col-sm-4 offset-md-1 py-4">
              <h4 class="text-white">Contact</h4>
              <ul class="list-unstyled">
                <li>
                  <a href="#" class="text-white">北京理工大学官网</a></li>
                <li>
                  <a href="#" class="text-white">网络开拓者协会(BITNP)主页</a></li>
                <li>
                  <a href="#" class="text-white">加入我们</a></li>
                <li>
                  <a href="#" class="text-white">联系我们</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="navbar navbar-dark bg-dark box-shadow">
        <div class="container d-flex justify-content-between">
          <a class="navbar-brand d-flex align-items-center" id="title-index">
            <strong>北理镜像站</strong></a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#headerNav" aria-controls="navbarHeader" aria-expended="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </div>
    </header>
    <main>
      <section class="jumbotron text-center">
        <div class="container">
          <h1 class="jumbotron-heading">北京理工大学开源软件镜像站</h1></div>
      </section>
      <div class="py-5 bg-light">
        <div class="container" id="main_container">
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="basic-addon3">请输入你想搜索的关键词</span></div>
            <input type="text" class="form-control" id="input-query" aria-describedby="basic-addon3">
            <div class="input-group-append">
              <button class="btn btn-outline-secondary" id="btn-search">搜索</button></div>
          </div>
          <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
              <div class="navbar-nav"></div>
              <div class="btn-group" role="group" id="pathNav" aria-label="path"></div>
            </div>
          </nav>
          <table class="table table-hover">
            <thead>
              <tr>
                <td>镜像名</td>
                <td>大小</td>
                <td>修改时间</td></tr>
            </thead>
            <tbody id="mirrors"></tbody>
          </table>
        </div>
      </div>
    </main>
    <footer class="text-muted">
      <div class="container">
        <p class="float-right">
          <a href="#">回到顶部</a></p>
        <p>Copyright © 1997-2018 Net Pioneer Association of BIT All Rights Reserved. Designed by Maidong</p>
      </div>
    </footer>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script type="text/javascript">var requests = null;
      function loadScript(url, callback) {
        var script = document.createElement("script");
        script.type = "text/javascript";
        if (typeof(callback) != "undefined") {
          if (script.readyState) {
            script.onreadystatechange = function() {
              if (script.readyState == "loaded" || script.readyState == "complete") {
                script.onreadystatechange = null;
                callback();
              }
            };
          } else {
            script.onload = function() {
              callback();
            };
          }
        }
        script.src = url;
        document.body.appendChild(script);
      }
      var host = window.location.origin;
      console.log(host);
      // loadScript(host+"/js/jquery-3.2.1.min.js", function () { //加载,并执行回调函数
      //   alert($(window).height());
      // }); 
      loadScript(host + "/js/jquery-3.2.1.min.js"); //加载js文件
      loadScript(host + "/js/functions.js"); //加载js文件 
      loadScript(host + "/js/socket.io-2.0.3.js",
      function() { // 为了确保在该文件加载完后才执行下面的代码，将剩下的代码全部放进这个匿名函数中

        $("#title-index").attr("href", host);

        //判断当前字符串是否以str开始 先判断是否存在function是避免和js原生方法冲突，自定义方法的效率不如原生的高  
        if (typeof String.prototype.startsWith != 'function') {
          String.prototype.startsWith = function(str) {
            return this.slice(0, str.length) == str;
          };
        }　　　　
        //判断当前字符串是否以str结束  
        if (typeof String.prototype.endsWith != 'function') {
          String.prototype.endsWith = function(str) {
            return this.slice( - str.length) == str;
          };
        }

        requests = GetRequest();

        var socket = io('http://localhost:3000');

        // 根据文件目录生成导航
        var path = window.location.pathname;
        var pathParts = path.split('/');
        for (item in pathParts) {
          if (pathParts[item] != "") {
            var btn = document.createElement('button');
						btn.type = 'button';
						btn.className = 'btn btn-secondary';
						btn.innerText = pathParts[item] + ' /';
						var pathNav = document.getElementById('pathNav');
						pathNav.appendChild(btn);
          }
        }
        // 点击导航按钮执行跳转
        $('#pathNav button').each(function() {
          var path = "";
          $(this).click(function() {
            console.log($(this).prevAll().length);
            var index = $(this).prevAll().length;
            for (var i = 0; i < index; i++) {
              path += $('#pathNav button').eq(i).text();
            }
            path += $('#pathNav button').eq(index).text();
            path = path.replace(/ /g, "");
            var href = '/' + path;
            console.log(href);
            window.location.href = href.substring(0, href.length - 1);
          });
        });

        socket.emit('data', {
          "type": "mirrorsDir",
          "path": path
        });
        socket.on('data',
        function(data) {
          console.log(data);
          data = dataFilter(data);
          console.log(data);
          window.data = data;
          loadHTML(data.datas);
        });

        // 搜索按钮
        $('#btn-search').click(function() {
          UrlJump({
            "query": $("#input-query").val()
          });
        });

        // 回车执行搜索
        $("#input-query").keydown(function(e) {
          switch (e.keyCode) {
          case 13:
            UrlJump({
              "query":
              $("#input-query").val()
            });
            break;
          default:
            break;
          }
        });

        // 加载网页内容
        function loadHTML(data) {
          var row = 0;
          for (var mir = 0; mir < data.length; mir++) {
            var path = data[mir].path;
            var type = data[mir].type;
            var osize = parseInt(data[mir].size);
            var mtime = data[mir].mtime;
            var size = null;
            if (osize < 1024) 										size = osize + ' B';
            else if (osize < 1024 * 1024) 				size = (osize / 1024).toFixed(2) + ' KB';
            else if (osize < 1024 * 1024 * 1024) 	size = (osize / 1024 / 1024).toFixed(2) + ' MB';
            else 																	size = (osize / 1024 / 1024 / 1024).toFixed(2) + ' GB';
            
            var tr = null;

            // if (type == "file") tr = '<tr><td>' + path + '</td><td>' + size + '</td><td>' + mtime + '</td></tr>';
            // else tr = '<tr><td>' + path + '</td><td> - </td><td> - </td></tr>';

            if(type == "file") {
            	tr = document.createElement('tr');
							td1 = document.createElement('td');
							td1.innerText = path;
							tr.appendChild(td1);
							td2 = document.createElement('td');
							td2.innerText = size;
							tr.appendChild(td2);
							td3 = document.createElement('td');
							td3.innerText = mtime;
							tr.appendChild(td3);
            } else {
							tr = document.createElement('tr');
							td1 = document.createElement('td');
							td1.innerText = path;
							tr.appendChild(td1);
							td2 = document.createElement('td');
							td2.innerText = "-";
							tr.appendChild(td2);
							td3 = document.createElement('td');
							td3.innerText = "-";
							tr.appendChild(td3);
            }
            document.getElementById("mirrors").appendChild(tr);
          }

          $('#mirrors tr').each(function() {
            $(this).on("click",
            function() {
              var href = window.location.pathname;
              href += '/' + $(this).find('td').eq(0).text();
              window.location.href = href;
            });
          });
        }


      });</script>
  </body>

</html>